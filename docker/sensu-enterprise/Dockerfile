# Source
FROM debian:stretch

# Labels
LABEL vendor=Sensu,\ Inc. \
  org.sensuapp.version="2.6.5-1" \
  org.sensuapp.release-date="2017-11-10"

# Build arguments
ARG SENSU_REPO_HOST=repositories.sensuapp.org
ARG SENSU_REPO_PATH=apt/pool/xenial/main/s/sensu
ARG SENSU_PACKAGE_VERSION=1.1.2-1
ARG SENSU_PACKAGE_ARCH=amd64
ARG SENSU_PACKAGE_FORMAT=deb
ARG SENSU_ENTERPRISE_REPO_USERNAME
ARG SENSU_ENTERPRISE_REPO_PASSWORD
ARG SENSU_ENTERPRISE_REPO_HOST=enterprise.sensuapp.com
ARG SENSU_ENTERPRISE_REPO_PATH=apt/pool/sensu-enterprise/unstable/s/sensu-enterprise
ARG SENSU_ENTERPRISE_PACKAGE_VERSION=3.1.0-1
ARG SENSU_ENTERPRISE_PACKAGE_ARCH=all
ARG SENSU_ENTERPRISE_PACKAGE_EXTENSION=deb

# Environment Variables
ENV \
  SENSU_ENTERPRISE_LOG_LEVEL="info" \
  SENSU_ENTERPRISE_CLIENT_SUBSCRIPTIONS="all,docker" \
  SENSU_ENTERPRISE_TRANSPORT_NAME="redis" \
  REDIS_URL="redis://${SENSU_REDIS_SERVICE_HOST:-127.0.0.1}:${SENSU_REDIS_SERVICE_PORT:-6379}"

# Build instructions
WORKDIR /tmp
RUN \
  apt-get update && apt-get install -y curl jq openjdk-8-jre && \
  echo "Downloading installer package: https://${SENSU_ENTERPRISE_REPO_USERNAME}:${SENSU_ENTERPRISE_REPO_PASSWORD}@${SENSU_ENTERPRISE_REPO_HOST}/${SENSU_ENTERPRISE_REPO_PATH}/sensu-enterprise_${SENSU_ENTERPRISE_PACKAGE_VERSION}_${SENSU_ENTERPRISE_PACKAGE_ARCH}.${SENSU_ENTERPRISE_PACKAGE_EXTENSION}" && \
  curl -LO "https://${SENSU_ENTERPRISE_REPO_USERNAME}:${SENSU_ENTERPRISE_REPO_PASSWORD}@${SENSU_ENTERPRISE_REPO_HOST}/${SENSU_ENTERPRISE_REPO_PATH}/sensu-enterprise_${SENSU_ENTERPRISE_PACKAGE_VERSION}_${SENSU_ENTERPRISE_PACKAGE_ARCH}.${SENSU_ENTERPRISE_PACKAGE_EXTENSION}" && \
  dpkg -i sensu-enterprise_${SENSU_ENTERPRISE_PACKAGE_VERSION}_${SENSU_ENTERPRISE_PACKAGE_ARCH}.${SENSU_ENTERPRISE_PACKAGE_EXTENSION} && \
  rm -f sensu-enterprise_${SENSU_ENTERPRISE_PACKAGE_VERSION}_${SENSU_ENTERPRISE_PACKAGE_ARCH}.${SENSU_ENTERPRISE_PACKAGE_EXTENSION} && \
  echo 'HEAP_SIZE="8192m"' >> /etc/default/sensu-enterprise

RUN \
  curl -LO https://${SENSU_REPO_HOST}/${SENSU_REPO_PATH}/sensu_${SENSU_PACKAGE_VERSION}_${SENSU_PACKAGE_ARCH}.${SENSU_PACKAGE_FORMAT} && \
  dpkg -i sensu_${SENSU_PACKAGE_VERSION}_${SENSU_PACKAGE_ARCH}.${SENSU_PACKAGE_FORMAT} && \
  rm -f sensu_${SENSU_PACKAGE_VERSION}_${SENSU_PACKAGE_ARCH}.${SENSU_PACKAGE_FORMAT} && \
  echo "EMBEDDED_RUBY=true" | tee /etc/default/sensu && \
  /opt/sensu/bin/sensu-client --print_config -d /etc/sensu/conf.d/

CMD /usr/bin/sensu-enterprise
