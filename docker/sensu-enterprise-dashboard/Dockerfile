# Source
FROM debian:stretch

# Labels
LABEL vendor=Sensu,\ Inc. \
  org.sensuapp.version="2.6.5-1" \
  org.sensuapp.release-date="2017-11-10"

# Build arguments
ARG SENSU_ENTERPRISE_REPO_USERNAME
ARG SENSU_ENTERPRISE_REPO_PASSWORD
ARG SENSU_ENTERPRISE_REPO_HOST=enterprise.sensuapp.com
ARG SENSU_ENTERPRISE_REPO_PATH=apt/pool/sensu-enterprise/unstable/s/sensu-enterprise-dashboard
ARG SENSU_ENTERPRISE_PACKAGE_VERSION=2.9.0-1
ARG SENSU_ENTERPRISE_PACKAGE_ARCH=amd64
ARG SENSU_ENTERPRISE_PACKAGE_EXTENSION=deb

# Environment Variables
ENV \
  SENSU_ENTERPRISE_LOG_LEVEL="info" \
  SENSU_ENTERPRISE_CLIENT_SUBSCRIPTIONS="all,docker" \
  SENSU_ENTERPRISE_TRANSPORT_NAME="redis" \
  REDIS_URL="redis://${SENSU_REDIS_SERVICE_HOST:-127.0.0.1}:${SENSU_REDIS_SERVICE_PORT:-6379}"

# Build instructions
WORKDIR /tmp
RUN \
  apt-get update && apt-get install -y curl jq && \
  echo "Downloading installer package: https://${SENSU_ENTERPRISE_REPO_USERNAME}:${SENSU_ENTERPRISE_REPO_PASSWORD}@${SENSU_ENTERPRISE_REPO_HOST}/${SENSU_ENTERPRISE_REPO_PATH}/sensu-enterprise-dashboard_${SENSU_ENTERPRISE_PACKAGE_VERSION}_${SENSU_ENTERPRISE_PACKAGE_ARCH}.${SENSU_ENTERPRISE_PACKAGE_EXTENSION}" && \
  curl -LO "https://${SENSU_ENTERPRISE_REPO_USERNAME}:${SENSU_ENTERPRISE_REPO_PASSWORD}@${SENSU_ENTERPRISE_REPO_HOST}/${SENSU_ENTERPRISE_REPO_PATH}/sensu-enterprise-dashboard_${SENSU_ENTERPRISE_PACKAGE_VERSION}_${SENSU_ENTERPRISE_PACKAGE_ARCH}.${SENSU_ENTERPRISE_PACKAGE_EXTENSION}" && \
  dpkg -i sensu-enterprise-dashboard_${SENSU_ENTERPRISE_PACKAGE_VERSION}_${SENSU_ENTERPRISE_PACKAGE_ARCH}.${SENSU_ENTERPRISE_PACKAGE_EXTENSION} && \
  rm -f sensu-enterprise-dashboard_${SENSU_ENTERPRISE_PACKAGE_VERSION}_${SENSU_ENTERPRISE_PACKAGE_ARCH}.${SENSU_ENTERPRISE_PACKAGE_EXTENSION}

CMD /usr/bin/sensu-enterprise-dashboard
